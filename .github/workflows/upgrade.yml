name: Upgrade Dependencies

on:
  schedule:
    - cron:  '0 10 * * 1'
  push:
    branches: [ main ]

jobs:
  upgrade-dep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: init hermit
        run: ./bin/hermit env --raw >> $GITHUB_ENV

      - name: upgrade hermit dependencies
        run: hermit upgrade

      - name: upgrade go dependencies
        run: go get -t -u ./...

      - name: create pull request
        id: create-pull-request
        uses: peter-evans/create-pull-request@v6
        with:
            commit-message: "chore: ↗️ update dependencies"
            title: "chore: ↗️ update dependencies"
            body: |
              - Upgrade hermit and go dependencies
  
              Auto-generated by a Github Action
            branch: upgrade-dependencies

      - name: automerge pull request
        if: steps.create-pull-request.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.create-pull-request.outputs.pull-request-number }}
          merge-method: squash
